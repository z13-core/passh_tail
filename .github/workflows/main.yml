name: PasSSH

on:
  workflow_dispatch:

jobs:
  secure-ssh-root:
    runs-on: ubuntu-latest
    timeout-minutes: 3550   # ~59 jam

    steps:
      - name: Update & Install Tailscale
        run: |
          sudo apt update -y
          sudo apt install -y curl
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Create admin user (root capable)
        run: |
          set -e
          if ! id -u admin >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash admin
          fi
          sudo usermod -aG sudo admin
          echo "admin ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/admin >/dev/null
          sudo chmod 440 /etc/sudoers.d/admin

      - name: Start Tailscale (with SSH)
        env:
          TS_AUTH: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -e
          sudo tailscale up --authkey="$TS_AUTH" --hostname=gh-auto-${{ github.run_id }} --ssh
          
          TS_IP=""
          for i in $(seq 1 15); do
            TS_IP=$(tailscale ip -4 | head -n1 || true)
            if [ -n "$TS_IP" ]; then
              break
            fi
            sleep 3
          done
          if [ -z "$TS_IP" ]; then
            echo "❌ Gagal mendapatkan IP Tailscale"
            exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Display SSH info
        run: |
          echo "========================================"
          echo "✅ Tailscale SSH ready"
          echo "Host: $TAILSCALE_IP"
          echo "SSH user: admin"
          echo ""
          echo "Connect using:"
          echo "  tailscale ssh admin@$TAILSCALE_IP"
          echo ""
          echo "Then elevate to root:"
          echo "  sudo -i"
          echo "========================================"

      - name: Keep Alive + Trigger Restart
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Restart otomatis sebelum batas waktu GitHub habis
          EXTEND_AFTER=$((59 * 60 * 60 - 600))
          echo "Menunggu $((EXTEND_AFTER/3600)) jam sebelum auto-restart..."

          SECONDS=0
          while [ $SECONDS -lt $EXTEND_AFTER ]; do
            echo "[$(date)] Workflow masih aktif..."
            sleep 300
          done

          echo "[$(date)] ⏳ Memicu workflow 'PasSSH-Restart'..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/pas-ssh-restart.yml/dispatches \
            -d '{"ref":"${{ github.ref_name }}"}'
